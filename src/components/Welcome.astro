---
import BaseLayout from '../layouts/BlogLayout.astro';
import { getCollection } from 'astro:content';
import profile from '../assets/profile.jpeg';

// Get all blog posts sorted by date
const allPosts = await getCollection('blog');
const latestPosts = allPosts
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .slice(0, 2);

// Calculate category counts
const categories = Array.from(
  new Set(allPosts.flatMap(post => post.data.tags ?? ['misc']))
)
  .map(tag => ({
    name: tag,
    count: allPosts.filter(
      post => post.data.tags?.includes(tag) ?? tag === 'misc'
    ).length
  }))
  .sort((a, b) => b.count - a.count);

const getRelativeTime = (date: string | Date): string => {
  try {
    const now = new Date();
    const diffMs = now.getTime() - new Date(date).getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;

    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric'
    }).format(new Date(date));
  } catch {
    return 'Unknown date';
  }
};
---

<main class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 md:px-8 py-8 md:py-12">

    <!-- Hero Section -->
    <section class="flex flex-col md:flex-row items-center md:items-start justify-between mb-4 gap-8">

      <div class="text-center md:text-left md:w-2/3">
        <div class="inline-flex items-center px-3 py-1.5 rounded-full bg-blue-50 text-blue-700 text-sm font-medium mb-4 border border-blue-100">
          Welcome to my digital space
        </div>

        <h1 class="sm:text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">
          <span class="text-xl">I'M</span>
          <span class="text-amber-300 block">Madan Belbase</span>
          <span class="text-xl block">Engineering Student.</span>
        </h1>

        <p class="text-gray-600 text-base sm:text-lg max-w-2xl mb-6">
          Passionate about coding, technology, and continuous learning.
        </p>

        <div class="flex gap-8 justify-center md:justify-start mb-6">
          <div class="text-center lg:text-left">
            <div class="text-3xl font-bold text-gray-900">{allPosts.length}</div>
            <div class="text-sm text-gray-600">Articles</div>
          </div>
          <div class="text-center lg:text-left">
            <div class="text-3xl font-bold text-gray-900">{categories.length}</div>
            <div class="text-sm text-gray-600">Topics</div>
          </div>
          <div class="text-center lg:text-left">
            <div class="text-3xl font-bold text-gray-900">∞</div>
            <div class="text-sm text-gray-600">Ideas</div>
          </div>
        </div>

        <a
          href="/about"
          class="inline-flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          About Me →
        </a>
      </div>

      <div class="md:w-1/3 flex justify-center">
        <div class="p-1 rounded-full bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 animate-float">
          <img
            src={profile.src}
            alt="Madan Belbase"
            loading="lazy"
            class="w-56 md:w-72 aspect-square rounded-full border-4 border-white shadow-2xl object-cover transform transition duration-500 ease-out hover:scale-110 hover:rotate-1"
          />
        </div>
      </div>

    </section>

    <!-- Recently Published -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="lg:col-span-2">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-8">
          Recently Published
        </h2>

        <div class="space-y-6">
          {latestPosts.map(post => (
            <article class="bg-white p-6 rounded-xl border shadow-sm">
              <h3 class="text-xl font-bold mb-2">
                <a href={`/blog/${post.slug}/`} class="hover:text-blue-600">
                  {post.data.title}
                </a>
              </h3>

              <div class="text-sm text-gray-500 mb-3">
                {getRelativeTime(post.data.pubDate)}
              </div>

              <p class="text-gray-600 mb-4">
                {post.data.description}
              </p>

              <a
                href={`/blog/${post.slug}/`}
                class="text-blue-600 font-semibold"
              >
                Read post →
              </a>
            </article>
          ))}
        </div>
      </div>

      <!-- Categories -->
      <aside>
        <div class="bg-white p-6 rounded-xl border shadow-sm">
          <h2 class="text-xl font-bold mb-4">Categories</h2>

          {categories.map(category => (
            <a
              href={`/blog/tag/${category.name.toLowerCase()}/`}
              class="flex justify-between py-2 hover:text-blue-600"
            >
              <span>{category.name}</span>
              <span>{category.count}</span>
            </a>
          ))}
        </div>
      </aside>

    </section>
  </div>
</main>
